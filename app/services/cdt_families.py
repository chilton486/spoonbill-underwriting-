CDT_FAMILY_MAP = {
    "D0100": "Preventive", "D0110": "Preventive", "D0120": "Preventive", "D0140": "Preventive",
    "D0150": "Preventive", "D0160": "Preventive", "D0170": "Preventive", "D0180": "Preventive",
    "D0210": "Preventive", "D0220": "Preventive", "D0230": "Preventive", "D0240": "Preventive",
    "D0250": "Preventive", "D0270": "Preventive", "D0272": "Preventive", "D0274": "Preventive",
    "D0277": "Preventive", "D0330": "Preventive", "D0340": "Preventive", "D0350": "Preventive",
    "D0470": "Preventive", "D0999": "Preventive",
    "D1110": "Preventive", "D1120": "Preventive", "D1206": "Preventive", "D1208": "Preventive",
    "D1310": "Preventive", "D1320": "Preventive", "D1330": "Preventive", "D1351": "Preventive",
    "D1352": "Preventive", "D1353": "Preventive", "D1354": "Preventive", "D1510": "Preventive",
    "D1515": "Preventive", "D1520": "Preventive", "D1525": "Preventive", "D1550": "Preventive",
    "D1555": "Preventive", "D1575": "Preventive",
    "D2140": "Restorative", "D2150": "Restorative", "D2160": "Restorative", "D2161": "Restorative",
    "D2330": "Restorative", "D2331": "Restorative", "D2332": "Restorative", "D2335": "Restorative",
    "D2390": "Restorative", "D2391": "Restorative", "D2392": "Restorative", "D2393": "Restorative",
    "D2394": "Restorative", "D2510": "Restorative", "D2520": "Restorative", "D2530": "Restorative",
    "D2542": "Restorative", "D2543": "Restorative", "D2544": "Restorative", "D2610": "Restorative",
    "D2620": "Restorative", "D2630": "Restorative", "D2642": "Restorative", "D2643": "Restorative",
    "D2644": "Restorative", "D2650": "Restorative", "D2651": "Restorative", "D2652": "Restorative",
    "D2662": "Restorative", "D2663": "Restorative", "D2664": "Restorative", "D2710": "Restorative",
    "D2720": "Restorative", "D2721": "Restorative", "D2722": "Restorative", "D2740": "Restorative",
    "D2750": "Restorative", "D2751": "Restorative", "D2752": "Restorative", "D2780": "Restorative",
    "D2790": "Restorative", "D2791": "Restorative", "D2792": "Restorative", "D2799": "Restorative",
    "D2910": "Restorative", "D2915": "Restorative", "D2920": "Restorative", "D2921": "Restorative",
    "D2929": "Restorative", "D2930": "Restorative", "D2931": "Restorative", "D2932": "Restorative",
    "D2933": "Restorative", "D2940": "Restorative", "D2950": "Restorative", "D2951": "Restorative",
    "D2952": "Restorative", "D2953": "Restorative", "D2954": "Restorative", "D2960": "Restorative",
    "D2961": "Restorative", "D2962": "Restorative", "D2971": "Restorative", "D2975": "Restorative",
    "D2980": "Restorative", "D2999": "Restorative",
    "D3110": "Endodontics", "D3120": "Endodontics", "D3220": "Endodontics", "D3221": "Endodontics",
    "D3222": "Endodontics", "D3230": "Endodontics", "D3240": "Endodontics", "D3310": "Endodontics",
    "D3320": "Endodontics", "D3330": "Endodontics", "D3331": "Endodontics", "D3332": "Endodontics",
    "D3333": "Endodontics", "D3346": "Endodontics", "D3347": "Endodontics", "D3348": "Endodontics",
    "D3351": "Endodontics", "D3352": "Endodontics", "D3353": "Endodontics", "D3410": "Endodontics",
    "D3421": "Endodontics", "D3425": "Endodontics", "D3426": "Endodontics", "D3430": "Endodontics",
    "D3450": "Endodontics", "D3460": "Endodontics", "D3470": "Endodontics", "D3920": "Endodontics",
    "D3999": "Endodontics",
    "D4210": "Periodontics", "D4211": "Periodontics", "D4212": "Periodontics", "D4230": "Periodontics",
    "D4231": "Periodontics", "D4240": "Periodontics", "D4241": "Periodontics", "D4245": "Periodontics",
    "D4249": "Periodontics", "D4260": "Periodontics", "D4261": "Periodontics", "D4263": "Periodontics",
    "D4264": "Periodontics", "D4270": "Periodontics", "D4271": "Periodontics", "D4273": "Periodontics",
    "D4274": "Periodontics", "D4275": "Periodontics", "D4276": "Periodontics", "D4277": "Periodontics",
    "D4278": "Periodontics", "D4283": "Periodontics", "D4285": "Periodontics", "D4320": "Periodontics",
    "D4321": "Periodontics", "D4341": "Periodontics", "D4342": "Periodontics", "D4346": "Periodontics",
    "D4355": "Periodontics", "D4381": "Periodontics", "D4910": "Periodontics", "D4920": "Periodontics",
    "D4921": "Periodontics", "D4999": "Periodontics",
    "D5110": "Prosthodontics", "D5120": "Prosthodontics", "D5130": "Prosthodontics", "D5140": "Prosthodontics",
    "D5211": "Prosthodontics", "D5212": "Prosthodontics", "D5213": "Prosthodontics", "D5214": "Prosthodontics",
    "D5221": "Prosthodontics", "D5222": "Prosthodontics", "D5223": "Prosthodontics", "D5224": "Prosthodontics",
    "D5225": "Prosthodontics", "D5226": "Prosthodontics", "D5282": "Prosthodontics", "D5283": "Prosthodontics",
    "D5284": "Prosthodontics", "D5286": "Prosthodontics", "D5410": "Prosthodontics", "D5411": "Prosthodontics",
    "D5421": "Prosthodontics", "D5422": "Prosthodontics", "D5511": "Prosthodontics", "D5512": "Prosthodontics",
    "D5520": "Prosthodontics", "D5611": "Prosthodontics", "D5612": "Prosthodontics", "D5620": "Prosthodontics",
    "D5630": "Prosthodontics", "D5640": "Prosthodontics", "D5650": "Prosthodontics", "D5660": "Prosthodontics",
    "D5670": "Prosthodontics", "D5671": "Prosthodontics", "D5710": "Prosthodontics", "D5711": "Prosthodontics",
    "D5720": "Prosthodontics", "D5721": "Prosthodontics", "D5730": "Prosthodontics", "D5731": "Prosthodontics",
    "D5740": "Prosthodontics", "D5741": "Prosthodontics", "D5750": "Prosthodontics", "D5751": "Prosthodontics",
    "D5760": "Prosthodontics", "D5761": "Prosthodontics", "D5810": "Prosthodontics", "D5811": "Prosthodontics",
    "D5820": "Prosthodontics", "D5821": "Prosthodontics", "D5850": "Prosthodontics", "D5851": "Prosthodontics",
    "D5862": "Prosthodontics", "D5863": "Prosthodontics", "D5864": "Prosthodontics", "D5865": "Prosthodontics",
    "D5866": "Prosthodontics", "D5867": "Prosthodontics", "D5899": "Prosthodontics", "D5999": "Prosthodontics",
    "D6010": "Prosthodontics", "D6012": "Prosthodontics", "D6040": "Prosthodontics", "D6050": "Prosthodontics",
    "D6055": "Prosthodontics", "D6056": "Prosthodontics", "D6057": "Prosthodontics", "D6058": "Prosthodontics",
    "D6059": "Prosthodontics", "D6060": "Prosthodontics", "D6061": "Prosthodontics", "D6062": "Prosthodontics",
    "D6063": "Prosthodontics", "D6064": "Prosthodontics", "D6065": "Prosthodontics", "D6066": "Prosthodontics",
    "D6067": "Prosthodontics", "D6068": "Prosthodontics", "D6069": "Prosthodontics", "D6070": "Prosthodontics",
    "D6071": "Prosthodontics", "D6072": "Prosthodontics", "D6073": "Prosthodontics", "D6074": "Prosthodontics",
    "D6075": "Prosthodontics", "D6076": "Prosthodontics", "D6077": "Prosthodontics", "D6080": "Prosthodontics",
    "D6081": "Prosthodontics", "D6085": "Prosthodontics", "D6090": "Prosthodontics", "D6091": "Prosthodontics",
    "D6092": "Prosthodontics", "D6093": "Prosthodontics", "D6094": "Prosthodontics", "D6095": "Prosthodontics",
    "D6100": "Prosthodontics", "D6101": "Prosthodontics", "D6102": "Prosthodontics", "D6103": "Prosthodontics",
    "D6104": "Prosthodontics", "D6110": "Prosthodontics", "D6111": "Prosthodontics", "D6112": "Prosthodontics",
    "D6113": "Prosthodontics", "D6114": "Prosthodontics", "D6115": "Prosthodontics", "D6116": "Prosthodontics",
    "D6117": "Prosthodontics", "D6118": "Prosthodontics", "D6119": "Prosthodontics", "D6120": "Prosthodontics",
    "D6121": "Prosthodontics", "D6190": "Prosthodontics", "D6199": "Prosthodontics", "D6205": "Prosthodontics",
    "D6210": "Prosthodontics", "D6211": "Prosthodontics", "D6212": "Prosthodontics", "D6214": "Prosthodontics",
    "D6240": "Prosthodontics", "D6241": "Prosthodontics", "D6242": "Prosthodontics", "D6245": "Prosthodontics",
    "D6250": "Prosthodontics", "D6251": "Prosthodontics", "D6252": "Prosthodontics", "D6253": "Prosthodontics",
    "D6545": "Prosthodontics", "D6548": "Prosthodontics", "D6549": "Prosthodontics", "D6600": "Prosthodontics",
    "D6601": "Prosthodontics", "D6602": "Prosthodontics", "D6603": "Prosthodontics", "D6604": "Prosthodontics",
    "D6605": "Prosthodontics", "D6606": "Prosthodontics", "D6607": "Prosthodontics", "D6608": "Prosthodontics",
    "D6609": "Prosthodontics", "D6610": "Prosthodontics", "D6611": "Prosthodontics", "D6612": "Prosthodontics",
    "D6613": "Prosthodontics", "D6614": "Prosthodontics", "D6615": "Prosthodontics", "D6624": "Prosthodontics",
    "D6634": "Prosthodontics", "D6710": "Prosthodontics", "D6720": "Prosthodontics", "D6721": "Prosthodontics",
    "D6722": "Prosthodontics", "D6740": "Prosthodontics", "D6750": "Prosthodontics", "D6751": "Prosthodontics",
    "D6752": "Prosthodontics", "D6780": "Prosthodontics", "D6781": "Prosthodontics", "D6782": "Prosthodontics",
    "D6783": "Prosthodontics", "D6784": "Prosthodontics", "D6790": "Prosthodontics", "D6791": "Prosthodontics",
    "D6792": "Prosthodontics", "D6793": "Prosthodontics", "D6794": "Prosthodontics", "D6920": "Prosthodontics",
    "D6930": "Prosthodontics", "D6940": "Prosthodontics", "D6950": "Prosthodontics", "D6980": "Prosthodontics",
    "D6985": "Prosthodontics", "D6999": "Prosthodontics",
    "D7111": "Oral Surgery", "D7140": "Oral Surgery", "D7210": "Oral Surgery", "D7220": "Oral Surgery",
    "D7230": "Oral Surgery", "D7240": "Oral Surgery", "D7241": "Oral Surgery", "D7250": "Oral Surgery",
    "D7251": "Oral Surgery", "D7260": "Oral Surgery", "D7261": "Oral Surgery", "D7270": "Oral Surgery",
    "D7272": "Oral Surgery", "D7280": "Oral Surgery", "D7282": "Oral Surgery", "D7283": "Oral Surgery",
    "D7285": "Oral Surgery", "D7286": "Oral Surgery", "D7287": "Oral Surgery", "D7288": "Oral Surgery",
    "D7290": "Oral Surgery", "D7291": "Oral Surgery", "D7292": "Oral Surgery", "D7293": "Oral Surgery",
    "D7294": "Oral Surgery", "D7310": "Oral Surgery", "D7311": "Oral Surgery", "D7320": "Oral Surgery",
    "D7321": "Oral Surgery", "D7340": "Oral Surgery", "D7350": "Oral Surgery", "D7410": "Oral Surgery",
    "D7411": "Oral Surgery", "D7412": "Oral Surgery", "D7413": "Oral Surgery", "D7414": "Oral Surgery",
    "D7415": "Oral Surgery", "D7440": "Oral Surgery", "D7441": "Oral Surgery", "D7450": "Oral Surgery",
    "D7451": "Oral Surgery", "D7460": "Oral Surgery", "D7461": "Oral Surgery", "D7465": "Oral Surgery",
    "D7471": "Oral Surgery", "D7472": "Oral Surgery", "D7473": "Oral Surgery", "D7485": "Oral Surgery",
    "D7490": "Oral Surgery", "D7510": "Oral Surgery", "D7511": "Oral Surgery", "D7520": "Oral Surgery",
    "D7521": "Oral Surgery", "D7530": "Oral Surgery", "D7540": "Oral Surgery", "D7550": "Oral Surgery",
    "D7560": "Oral Surgery", "D7610": "Oral Surgery", "D7620": "Oral Surgery", "D7630": "Oral Surgery",
    "D7640": "Oral Surgery", "D7650": "Oral Surgery", "D7660": "Oral Surgery", "D7670": "Oral Surgery",
    "D7680": "Oral Surgery", "D7710": "Oral Surgery", "D7720": "Oral Surgery", "D7730": "Oral Surgery",
    "D7740": "Oral Surgery", "D7750": "Oral Surgery", "D7760": "Oral Surgery", "D7770": "Oral Surgery",
    "D7780": "Oral Surgery", "D7810": "Oral Surgery", "D7820": "Oral Surgery", "D7830": "Oral Surgery",
    "D7840": "Oral Surgery", "D7850": "Oral Surgery", "D7852": "Oral Surgery", "D7854": "Oral Surgery",
    "D7856": "Oral Surgery", "D7858": "Oral Surgery", "D7860": "Oral Surgery", "D7865": "Oral Surgery",
    "D7870": "Oral Surgery", "D7871": "Oral Surgery", "D7872": "Oral Surgery", "D7873": "Oral Surgery",
    "D7874": "Oral Surgery", "D7875": "Oral Surgery", "D7876": "Oral Surgery", "D7877": "Oral Surgery",
    "D7880": "Oral Surgery", "D7881": "Oral Surgery", "D7899": "Oral Surgery", "D7910": "Oral Surgery",
    "D7911": "Oral Surgery", "D7912": "Oral Surgery", "D7920": "Oral Surgery", "D7921": "Oral Surgery",
    "D7922": "Oral Surgery", "D7940": "Oral Surgery", "D7941": "Oral Surgery", "D7943": "Oral Surgery",
    "D7944": "Oral Surgery", "D7945": "Oral Surgery", "D7946": "Oral Surgery", "D7947": "Oral Surgery",
    "D7948": "Oral Surgery", "D7949": "Oral Surgery", "D7950": "Oral Surgery", "D7951": "Oral Surgery",
    "D7952": "Oral Surgery", "D7953": "Oral Surgery", "D7955": "Oral Surgery", "D7960": "Oral Surgery",
    "D7963": "Oral Surgery", "D7970": "Oral Surgery", "D7971": "Oral Surgery", "D7972": "Oral Surgery",
    "D7979": "Oral Surgery", "D7980": "Oral Surgery", "D7981": "Oral Surgery", "D7982": "Oral Surgery",
    "D7983": "Oral Surgery", "D7990": "Oral Surgery", "D7991": "Oral Surgery", "D7995": "Oral Surgery",
    "D7996": "Oral Surgery", "D7997": "Oral Surgery", "D7998": "Oral Surgery", "D7999": "Oral Surgery",
    "D8010": "Orthodontics", "D8020": "Orthodontics", "D8030": "Orthodontics", "D8040": "Orthodontics",
    "D8050": "Orthodontics", "D8060": "Orthodontics", "D8070": "Orthodontics", "D8080": "Orthodontics",
    "D8090": "Orthodontics", "D8210": "Orthodontics", "D8220": "Orthodontics", "D8660": "Orthodontics",
    "D8670": "Orthodontics", "D8680": "Orthodontics", "D8681": "Orthodontics", "D8690": "Orthodontics",
    "D8691": "Orthodontics", "D8692": "Orthodontics", "D8693": "Orthodontics", "D8694": "Orthodontics",
    "D8695": "Orthodontics", "D8696": "Orthodontics", "D8697": "Orthodontics", "D8698": "Orthodontics",
    "D8699": "Orthodontics", "D8701": "Orthodontics", "D8702": "Orthodontics", "D8703": "Orthodontics",
    "D8704": "Orthodontics", "D8999": "Orthodontics",
}

ALL_FAMILIES = ["Preventive", "Restorative", "Endodontics", "Periodontics", "Prosthodontics", "Oral Surgery", "Orthodontics", "Other"]

PREVENTIVE_CODES = {code for code, fam in CDT_FAMILY_MAP.items() if fam == "Preventive"}


def get_cdt_family(code: str) -> str:
    if not code:
        return "Other"
    c = code.strip().upper()
    if c in CDT_FAMILY_MAP:
        return CDT_FAMILY_MAP[c]
    if len(c) >= 2:
        prefix = c[0]
        try:
            num = int(c[1:5]) if len(c) >= 5 else int(c[1:])
        except ValueError:
            return "Other"
        if prefix == "D":
            if 0 <= num < 1000:
                return "Preventive"
            if 1000 <= num < 2000:
                return "Preventive"
            if 2000 <= num < 3000:
                return "Restorative"
            if 3000 <= num < 4000:
                return "Endodontics"
            if 4000 <= num < 5000:
                return "Periodontics"
            if 5000 <= num < 7000:
                return "Prosthodontics"
            if 7000 <= num < 8000:
                return "Oral Surgery"
            if 8000 <= num < 9000:
                return "Orthodontics"
    return "Other"


def get_family_counts(procedure_codes_list: list) -> dict:
    counts = {}
    for code in procedure_codes_list:
        fam = get_cdt_family(code)
        counts[fam] = counts.get(fam, 0) + 1
    return counts
